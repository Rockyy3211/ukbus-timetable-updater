- name: Download TXC datasets (North West)
  shell: bash
  env:
    API: ${{ env.BODS_API_KEY }}   # make sure this secret exists!
  run: |
    set -euo pipefail

    BASE="https://data.bus-data.dft.gov.uk/api/v1/dataset/?dataType=Timetables&page_size=1000"

    # Call BODS with your API key; capture HTTP status
    HTTP=$(curl -sS -H "Authorization: ApiKey $API" -H "Accept: application/json" \
      -o datasets.json -w "%{http_code}" "$BASE")

    echo "BODS HTTP status: $HTTP"
    # If not 200, show the body and fail clearly
    if [ "$HTTP" != "200" ]; then
      echo "---- BODS response body (truncated) ----"
      head -c 1000 datasets.json || true
      echo
      echo "::error::BODS API request failed (HTTP $HTTP). Check BODS_API_KEY secret."
      exit 1
    fi

    # Sanity: ensure .results exists; fallback to empty array to avoid jq error
    COUNT=$(jq '(.results // []) | length' datasets.json)
    echo "Datasets returned: $COUNT"

    if [ "$COUNT" -eq 0 ]; then
      echo "::warning::BODS returned 0 datasets. Printing first 400 chars for debugging:"
      head -c 400 datasets.json || true
      exit 1
    fi

    # Filter to North West (name/adminAreas), then grab up to 10 download URLs for first run
    jq -r '
      (.results // [])
      | map(select(
          (.name | test("(?i)north\\s*west|greater manchester|merseyside|lancashire|cumbria|cheshire|blackpool|blackburn|warrington|halton|westmorland|cumberland"))
          or ((.adminAreas // [])[] | test("(?i)(Greater Manchester|Merseyside|Lancashire|Cumbria|Cheshire East|Cheshire West and Chester|Blackburn with Darwen|Blackpool|Warrington|Halton|Westmorland and Furness|Cumberland)"))
        ))
      | .[:10]                        # limit for first run; remove later
      | .[] .download_url
    ' datasets.json | while read -r u; do
      [ -z "$u" ] && continue
      echo "Downloading $u"
      curl -Ls "$u" -o "txc-build/downloads/$(basename "$u")"
    done

    echo "Download step complete."
