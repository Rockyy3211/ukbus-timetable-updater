- name: Download TXC datasets (North West)
  shell: bash
  env:
    API: ${{ secrets.BODS_API_KEY }}
  run: |
    set -euo pipefail

    if [ -z "${API:-}" ]; then
      echo "::error::BODS_API_KEY secret is empty or missing."; exit 1
    fi

    # Hide the key in logs
    echo "::add-mask::$API"

    BASE="https://data.bus-data.dft.gov.uk/api/v1/dataset/?dataType=Timetables&page_size=1000&api_key=$API"

    # Call BODS and capture HTTP code
    HTTP=$(curl -sS -H "Accept: application/json" -o datasets.json -w "%{http_code}" "$BASE")
    echo "BODS HTTP status: $HTTP"

    if [ "$HTTP" != "200" ]; then
      echo "---- Response (first 800 chars) ----"
      head -c 800 datasets.json || true
      echo
      echo "::error::BODS API failed (HTTP $HTTP). Check BODS_API_KEY."
      exit 1
    fi

    COUNT=$(jq '(.results // []) | length' datasets.json)
    echo "Datasets returned: $COUNT"
    if [ "$COUNT" -eq 0 ]; then
      echo "::error::BODS returned 0 datasets."; exit 1
    fi

    # Filter to North West, limit to 10 for first run (remove | .[:10] later)
    jq -r '
      (.results // [])
      | map(select(
          (.name | test("(?i)north\\s*west|greater manchester|merseyside|lancashire|cumbria|cheshire|blackpool|blackburn|warrington|halton|westmorland|cumberland"))
          or ((.adminAreas // [])[] | test("(?i)(Greater Manchester|Merseyside|Lancashire|Cumbria|Cheshire East|Cheshire West and Chester|Blackburn with Darwen|Blackpool|Warrington|Halton|Westmorland and Furness|Cumberland)"))
        ))
      | .[:10]
      | .[] .download_url
    ' datasets.json | while read -r u; do
      [ -z "$u" ] && continue
      echo "Downloading $u"
      curl -Ls "$u" -o "txc-build/downloads/$(basename "$u")"
    done
