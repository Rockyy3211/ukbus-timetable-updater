name: Build & publish TXC (North West)

on:
  schedule:
    - cron: "0 3 * * 1"   # Mondays 03:00 UTC
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      CF_API_TOKEN:  ${{ secrets.CF_API_TOKEN }}     # wrangler token with KV write
      KV_NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}# BUS_SERVICES_KV namespace ID
      BODS_API_KEY:  ${{ secrets.BODS_API_KEY }}

    steps:
      - uses: actions/checkout@v4

      - name: Prepare dirs
        run: mkdir -p txc-build/downloads txc-build/shards

      - name: Install build deps
        working-directory: txc-build
        run: npm ci

      - name: Download TXC datasets (North West)
        shell: bash
        env:
          API: ${{ env.BODS_API_KEY }}
        run: |
          set -e
          BASE="https://data.bus-data.dft.gov.uk/api/v1/dataset/?dataType=Timetables&page_size=1000"
          curl -s -H "Authorization: ApiKey $API" "$BASE" > datasets.json

          # Filter by dataset name or admin areas commonly in NW (adjust over time)
          jq -r '
            .results[]
            | select(
                (.name | test("(?i)north\\s*west|greater manchester|merseyside|lancashire|cumbria|cheshire|blackpool|blackburn|warrington|halton|westmorland|cumberland"))
                or ((.adminAreas // [])[] | test("(?i)(Greater Manchester|Merseyside|Lancashire|Cumbria|Cheshire East|Cheshire West and Chester|Blackburn with Darwen|Blackpool|Warrington|Halton|Westmorland and Furness|Cumberland)"))
              )
            | .download_url
          ' datasets.json | while read -r u; do
            [ -z "$u" ] && continue
            echo "Downloading $u"
            curl -Ls "$u" -o "txc-build/downloads/$(basename "$u")"
          done

      - name: Build stopâ†’services index
        working-directory: txc-build
        run: npm run build

      - name: Shard JSON
        working-directory: txc-build
        run: npm run shard

      - name: Install wrangler
        run: npm i -g wrangler

      - name: Upload to Cloudflare KV (per ATCO)
        working-directory: txc-build/shards
        env:
          CF_ACCOUNT_ID: ${{ env.CF_ACCOUNT_ID }}
          KV_NAMESPACE_ID: ${{ env.KV_NAMESPACE_ID }}
        run: |
          set -e
          for f in *.json; do
            echo "Uploading shard $f"
            jq -r 'to_entries[] | "\(.key)\t\(.value|tojson)"' "$f" | \
            while IFS=$'\t' read -r atco payload; do
              wrangler kv key put \
                --account-id "$CF_ACCOUNT_ID" \
                --namespace-id "$KV_NAMESPACE_ID" \
                "$atco" "$payload" --force
            done
          done

      - name: Done
        run: echo "KV updated."
