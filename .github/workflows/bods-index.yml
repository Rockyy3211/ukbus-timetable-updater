- name: Download TXC datasets (North West)
  shell: bash
  env:
    API: ${{ secrets.BODS_API_KEY }}
  run: |
    set -euo pipefail
    [ -z "${API:-}" ] && { echo "::error::BODS_API_KEY is missing"; exit 1; }
    echo "::add-mask::$API"

    # ---- 1) Try the metadata API (preferred) ----
    META_URL="https://data.bus-data.dft.gov.uk/api/v1/dataset/?limit=1000&status=published&api_key=$API"
    HTTP=$(curl -sS -H "Accept: application/json" -o datasets.json -w "%{http_code}" "$META_URL")
    echo "BODS metadata HTTP: $HTTP"

    if [ "$HTTP" = "200" ]; then
      COUNT=$(jq '(.results // []) | length' datasets.json)
      echo "Metadata records: $COUNT"
      if [ "$COUNT" -eq 0 ]; then
        echo "::error::BODS returned 0 datasets"; exit 1
      fi

      # Filter to North West via name/adminAreas and take first 10 for a test run (remove | .[:10] later)
      jq -r '
        (.results // [])
        | map(select(
            (.name | test("(?i)north\\s*west|greater manchester|merseyside|lancashire|cumbria|cheshire|blackpool|blackburn|warrington|halton|westmorland|cumberland"))
            or ((.adminAreas // [])[] | test("(?i)(Greater Manchester|Merseyside|Lancashire|Cumbria|Cheshire East|Cheshire West and Chester|Blackburn with Darwen|Blackpool|Warrington|Halton|Westmorland and Furness|Cumberland)"))
          ))
        | .[:10]
        | .[] .download_url
      ' datasets.json | while read -r u; do
        [ -z "$u" ] && continue
        echo "Downloading $u"
        mkdir -p txc-build/downloads
        curl -Ls "$u" -o "txc-build/downloads/$(basename "$u")"
      done

      echo "Download step complete (metadata route)."
      exit 0
    fi

    echo "---- Metadata API failed (HTTP $HTTP). Body (first 800 chars): ----"
    head -c 800 datasets.json || true
    echo

    # ---- 2) Fallback: bulk download (whole-country zip). Comment this block out if not desired. ----
    echo "::warning::Falling back to bulk download (entire GB timetables)."
    BULK_URL="https://data.bus-data.dft.gov.uk/timetable/download/?api_key=$API"
    mkdir -p txc-build/downloads
    curl -fL "$BULK_URL" -o txc-build/downloads/all-timetables.zip
    echo "Bulk download complete."
